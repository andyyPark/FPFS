We first introduce the second generation of FPFS shear estimator in Section
\ref{sec_Method_shapelets} and the revision of selection bias in Section
\ref{sec_Method_select}. Then, we summarize the difference between the updated
FPFS algorithm with its first generation.

\subsection{FPFS2 Shear estimator}
\label{sec_Method_shapelets}

\citet{Z08} first proposed to measure shear from the Fourier power function of
galaxy images. The Fourier power function of a galaxy is defined as
\begin{equation} \label{eq:FourPowDef}
\begin{split}
\tilde{f}_o(\vec{k})&=\int f_o(\vec{x}_o) e^{-i\vec{k} \cdot \vec{x}_o} d^2x_o,\\
\tilde{F}_o(\vec{k})&=|\tilde{f}_o(\vec{k})|^2.
\end{split}
\end{equation}

The Fourier power function defined in equation (\ref{eq:FourPowDef}) is
contaminated by the Fourier power function of noise. Although noise on CCD
images (single exposures) does not correlate across pixels \citep{Z15}, noise
on coadd exposures correlates across pixels as an ad hoc warping kernel is used
to convolve CCD images before re-pixelazing onto common coordinates in the
coadding procedure. In this paper, we assume the noise's Fourier power function
is fully known, which is denoted as $\tilde{F}_n$. The noise's Fourier power
function is subtracted from the galaxy's Fourier power function
\begin{equation}
    \tilde{F}_r(\vec{k})=\tilde{F}_o(\vec{k})-\mathcal{P}.
\end{equation}

Subsequently, the PSF's Fourier power function, which is denoted as
$\tilde{G}(\vec{k})$, is deconvolved to revise for the smearing from PSF, and
the deconvolved galaxy's Fourier power function is projected onto the polar
Shapelet basis vectors \citep{polar_Shapelets} as
\begin{align}\label{Shapelets_decompose}
M_{nm}=\int \chi_{nm}^\dagger \frac{\tilde{F}_r}{\tilde{G}}\rho d\rho d\phi,
\end{align}
where $\rho$ and $\phi$ are the radius and position angle in the polar
coordinates. The polar Shapelet basis vectors are defined as
\begin{align*}
\chi_{nm}(\rho,\phi)&=\frac{(-1)^{(n-|m|)/2}}{\sigma^{|m|+1}}\left\lbrace
    \frac{[(n-|m|)/2]!}{\pi[(n+|m|)/2]!}\right\rbrace^\frac{1}{2}\\
    &\times
    \rho^{|m|}L^{|m|}_{\frac{n-|m|}{2}}\left(\frac{r^2}{\sigma^2}\right)e^{-\rho^2/2\sigma^2}
    e^{-im\phi},
\end{align*}
where $L^{p}_{q}$ are the Laguerre Polynomials, $n$ is the radial number and
$m$ is the spin number, and $\sigma$ determines the scale of Shapelet
functions. We denote the ratio between $\sigma$ and the scale radius of PSF
Fourier power function ($r_{\text{pp}}$) as \citep{FPFS-Li2018}
\begin{equation}
\beta=\frac{\sigma}{r_{\text{pp}}}.
\end{equation}
Note $\beta$ determines the effective scale in Fourier space.
\citet{FPFS-Li2018} proposed to set $\beta=0.85$.

The transformations (\citep{polar_Shapelets}) of many useful shapelet modes
under the influence of shear are laid out as follows
\begin{equation}\label{Shapelets_Moments_shear_Transform}
\begin{split}
M_{22c}&=\bar{M}_{22c}-\frac{\sqrt{2}}{2}g_1(\bar{M}_{00}-\bar{M}_{40})\\
&+\sqrt{3}g_1 \bar{M}_{44c}+\sqrt{3} g_2 \bar{M}_{44s},\\
M_{22s}&=\bar{M}_{22s}-\frac{\sqrt{2}}{2}g_2(\bar{M}_{00}-\bar{M}_{40})\\
&-\sqrt{3}g_2 \bar{M}_{44c}+\sqrt{3} g_1 \bar{M}_{44s},\\
M_{00} &=\bar{M}_{00}+\sqrt{2}(g_1\bar{M}_{22c}+g_2\bar{M}_{22s}),\\
M_{20} &=\bar{M}_{20}+\sqrt{6}(g_1\bar{M}_{42c}+g_2\bar{M}_{42s}),\\
M_{40} &=\bar{M}_{40}-\sqrt{2}(g_1\bar{M}_{22c}+g_2\bar{M}_{22s})\\
&+2\sqrt{3}(g_1\bar{M}_{62c}+g_2\bar{M}_{62s}),
\end{split}
\end{equation}
where $\bar{M}_{nm}$ represent the intrinsic shapelet modes and $M_{nm}$
represent the sheared shapelet modes.

We define the dimensionless FPFS ellipticity and the corresponding shear
response with these shapelet modes as
\begin{align}\label{ellipticity_define}
e_1=\frac{M_{22c}}{M_{20}+C},\qquad
e_2=\frac{M_{22s}}{M_{20}+C},\\
R_{1}=\frac{\sqrt{2}}{2}\frac{M_{00}-M_{40}}{M_{20}+C}
    +\sqrt{6}\frac{M_{22c}}{M_{20}+C}\frac{M_{42c}}{M_{20}+C},\\
R_{2}=\frac{\sqrt{2}}{2}\frac{M_{00}-M_{40}}{M_{20}+C}
    +\sqrt{6}\frac{M_{22s}}{M_{20}+C}\frac{M_{42s}}{M_{20}+C},
\end{align}
$M_{nmc}$ and $M_{nms}$ are used to denote the real and imaginary part of
$M_{nm}$ when $m>0$. The constant $C=\nu \sigma(M_{20})$ the weighting
parameter which adjusts weight between galaxies with different luminosity and
reduces noise bias, and $\nu$ is termed weighting ratio \citep{FPFS-Li2018}.

With the definition of average response $R= (R_1+R_2)/2$, the final shear
estimator is
\begin{equation}
\gamma_{1,2} =-\frac{\left\langle e_{1,2}
\right\rangle}{\left\langle R \right\rangle}.
\end{equation}

\subsection{Noise bias}
\label{sec_Method_noise}

\subsubsection{pure noise}

The Gaussian noise field is denoted as $n(\vec{x})$ and its Fourier transform
is denoted as $\tilde{n}(\vec{k})$. According to the Isserlis' theorem, we have
\begin{equation}\label{eq_IsserlisTheorem}
\begin{split}
    \tilde{n}_2(\vec{k})=\left\langle\tilde{n}\tilde{n}^{\dagger}\right\rangle
    &=\mathcal{P}(\vec{k}),\\
    \tilde{n}_4(\vec{k})=\left\langle\tilde{n}\tilde{n}\tilde{n}^\dagger\tilde{n}^\dagger\right\rangle
    &=
    \begin{cases}
    3\mathcal{P}^2(\vec{k}) &\mbox{if } \vec{k}=0,\\
    2\mathcal{P}^2(\vec{k}) &\mbox{else}.\\
    \end{cases}
\end{split}
\end{equation}
The residual of noise power function is defined as
\begin{equation}\label{eq_ps_res}
    \tilde{\epsilon}(\vec{k})=\tilde{n}\tilde{n}^\dagger
    -\mathcal{P}(\vec{k}),
\end{equation}
and the standard deviation of the residual can be calculated by combining
eq.(\ref{eq_ps_res}) with eq.  (\ref{eq_IsserlisTheorem}):
\begin{equation}
    \sigma^2_{\tilde{\epsilon}}(\vec{k})=\tilde{n}_4(\vec{k})-\mathcal{P}^2(\vec{k})
\end{equation}

\subsubsection{noisy galaxy}
However, when we have a galaxy in the noise field, the combined field is
\begin{equation}
    \tilde{f}_o(\vec{k})=\tilde{f}(\vec{k})+\tilde{n}(\vec{k}),
\end{equation}
and the total power function is
\begin{equation}
    \tilde{F}_o(\vec{k})= \tilde{F}+\tilde{n}\tilde{n}^\dagger
    +\tilde{f}\tilde{n}^{\dagger}+\tilde{f}^{\dagger}\tilde{n},
\end{equation}
with the definition of residuals on the power function:
\begin{equation}\label{eq_ps_res_gal}
    \tilde{\epsilon}(\vec{k})=\tilde{n}\tilde{n}^\dagger
    +\tilde{f}\tilde{n}^{\dagger}+\tilde{f}^{\dagger}\tilde{n}
    -\mathcal{P}(\vec{k}),
\end{equation}
the power function of galaxy after removing the noise power function is
\begin{equation}
    \tilde{F}_r(\vec{k})=\tilde{F}(\vec{k})+\tilde{\epsilon}(\vec{k}).
\end{equation}
With eq. (\ref{eq_IsserlisTheorem}), the variance of the residual is calculated
as
\begin{equation}\label{eq_var_res_noisyGal}
    \sigma^2_{\tilde{\epsilon}}(\vec{k})=
    \begin{cases}
        2\mathcal{P}^2+4\tilde{F}\mathcal{P} &\mbox{if } \vec{k}=0,\\
        \mathcal{P}^2+2\tilde{F}\mathcal{P} &\mbox{else}.
    \end{cases}
\end{equation}

\subsubsection{Shapelet modes revision}
We define the shapelet modes of residuals as $\mathcal{E}_{nm}$, and the
expectation of these residual shapelet modes equal zero. The second-order
statistical properties of these modes are
\begin{equation}
    \begin{split}
    \left\langle \mathcal{E}_{nm}\mathcal{E}^{\dagger}_{n'm'} \right\rangle
    &=\int \frac{\chi^\dagger_{nm}\chi_{n'm'}}{\tilde{G}^2(\vec{k})}
    \sigma^2_{\tilde{\epsilon}}(\vec{k})d^2k\\
    &=\int \frac{\chi^\dagger_{nm}\chi_{n'm'}}{\tilde{G}^2(\vec{k})}
    \left(\mathcal{P}^2+2\tilde{F}\mathcal{P}\right)
    \end{split}
\end{equation}
The observed FPFS ellipticity is revise as
\begin{equation}
    \begin{split}
    \left\langle e^o_1\right\rangle
    &=\left\langle\frac{M_{22c}+\mathcal{E}_{22c}}
        {M_{20}+C+\mathcal{E}_{20}}\right\rangle\\
    % &=\left\langle e_1\right\rangle
    %     -\left\langle\frac{\mathcal{E}_{20}\mathcal{E}_{22c}}
    %     {(M_{20}+C)^2}\right\rangle
    %     + O(\delta^4)\\
    % The shot noise realization is independent of galaxy shape noise
    % realization
    &=\left\langle e_1\right\rangle+
        \left\langle
        \frac{M_{22c}\left\langle\mathcal{E}_{20}\mathcal{E}_{20}\right\rangle}
        {(M_{20}+C)^3}
        \right\rangle
    -\left\langle
    \frac{\left\langle\mathcal{E}_{20}\mathcal{E}_{22c}\right\rangle}
        {(M_{20}+C)^2}
    \right\rangle
    \end{split}
\end{equation}

\begin{equation}
    \begin{split}
    \left\langle \frac{M^o_{00}-M^o_{40}}{M^o_{20}+C}\right\rangle
    &=\left\langle
        \frac{M_{00}-M_{40}}{M_{20}+C}\right\rangle+\left\langle
        \frac{\left(M_{00}-M_{40}\right)
            \left\langle\mathcal{E}_{20}\mathcal{E}_{20}\right\rangle}
        {(M_{20}+C)^3}
        \right\rangle\\
    &-\left\langle
    \frac{\langle\mathcal{E}_{20}
    (\mathcal{E}_{00}-\mathcal{E}_{40})\rangle}
    {(M_{20}+C)^2}
    \right\rangle
    \end{split}
\end{equation}

\begin{equation}
\begin{split}
    \left\langle \frac{M^o_{22c}M^o_{42c}}{(M^o_{20}+C)^2}\right\rangle
    &= \left\langle \frac{M_{22c}M_{42c}}{(M_{20}+C)^2}\right\rangle\\
    &+3\left\langle\frac{M_{22c}M_{42c}
        \left\langle\mathcal{E}_{20}\mathcal{E}_{20}\right\rangle}
                    {(M_{20}+C)^4}
    \right\rangle
    + \left\langle
        \frac{\langle\mathcal{E}_{22c}\mathcal{E}_{42c}\rangle}{(M_{20}+C)^2}
        \right\rangle\\
    &- 2\left\langle\frac{M_{42c}\langle\mathcal{E}_{22c}\mathcal{E}_{20}\rangle}
        {(M_{20}+C)^3}
        + \frac{M_{22c}\langle\mathcal{E}_{42c}\mathcal{E}_{20}\rangle}
        {(M_{20}+C)^3}\right\rangle\\
\end{split}
\end{equation}

\subsection{Selection Bias}
\label{sec_Method_select}
Selection bias refers to the multiplicative bias or additive bias caused by
selection. Such bias emerges if the observable used for selection correlates
with the shear signal (multiplicative bias) or the ellipticities of PSF
(additive bias).
We denote the observable used for selection as $X$ and the correlation with the
shear or PSF ellipticities has the form
\begin{equation}
X=\bar{X}+g_1Y_1+e_{\rm{PSF,1}}Z_1+....
\end{equation}
Here $\bar{X}$ refers to the intrinsic property before the shear distortion and
PSF smearing, $Y$ refers to the response of the property $\bar{X}$ to the shear
which is a spin-$2$ property, and $Z$ quantifies the correlation between the
observed property $X$ and the shape of PSF which is caused by the imperfect PSF
revision in the observation of $X$. We follow \citet{HSC1-GREAT3Sim} and give
out the changes in the first component of ellipticities due to the selection
\begin{equation}
\begin{split}
\Delta \left\langle e_1\right \rangle  &= g_1\int \frac{dn}{Nd\Omega } |_{X=X_{\rm{edge}}} Y_1 e_1 d\Omega \\
        &+ e_{\rm{PSF,1}} \int \frac{dn}{Nd\Omega}|_{X=X_{\rm{edge}}} Z_1 e_1 d\Omega.
\end{split}
\end{equation}
Then with the assumption that
\begin{equation}
\begin{split}
 \frac{dn}{Nd\Omega}&=p_a(X)p_b(\Omega')\\
\end{split}
\end{equation}
we have
\begin{equation}
\begin{split}
\Delta \left\langle e_1\right \rangle  &= g_1p_a(X_{\rm{edge}})\int p_b Y_1 e_1
d\Omega'|_{X=X_{\rm{edge}}} \\ &+ e_{\rm{PSF,1}} p_a(X_{\rm{edge}}) \int p_b
Z_1 e_1 d\Omega'|_{X=X_{\rm{edge}}} .
\end{split}
\end{equation}
The multiplicative selection bias and additive selection bias is defined as
\begin{equation}
\begin{split}
m_{\rm{sel}}&=p_a(X_{\rm{edge}})\int p_b Y_1 e_1 d\Omega'|_{X=X_{\rm{edge}}} \\
            &=p_a(X_{\rm{edge}}) A_m,\\
\end{split}
\end{equation}

\begin{equation}
\begin{split}
a_{\rm{sel}}&=p_a(X_{\rm{edge}}) \int p_b Z_1 e_1 d\Omega'|_{X=X_{\rm{edge}}} \\
            &=p_a(X_{\rm{edge}}) A_a,
\end{split}
\end{equation}
respectively. We denote the ratio between the multiplicative (additive) bias and partial density function
at $X_{\rm{edge}}$ as $A_{m}$ ($A_{a}$).

We define the FPFS flux ratio as
\begin{align}\label{select_define}
s = \frac{M_{00}}{M_{20}+C},
\end{align}
and use the FPFS flux ratio as the selection function.

The FPFS flux ratio is also influenced by the shear and the relationship
between the sheared FPFS flux ratio ($s$) and the intrinsic FPFS flux ratio
($\bar{s}$) is
\begin{align}\label{select_transform}
s-\bar{s} &=g_1 (\sqrt{2}\frac{M_{22c}}{M_{20}+C}
    -\sqrt{6}s\frac{M_{42c}}{M_{20}+C}) \\
    &+g_2 (\sqrt{2}\frac{M_{22s}}{M_{20}+C}
    -\sqrt{6}s\frac{M_{42s}}{M_{20}+C}).
\end{align}
$\bar{s}$ is isotropic (spin-0) on the intrinsic plane but $s$ is not.
Therefore, the selection using $s$ as the selection function is not an
isotropic selection on the intrinsic plane. Such selection does not align with
the premise that the intrinsic galaxies have isotropic orientations
statistically and causes selection bias.
